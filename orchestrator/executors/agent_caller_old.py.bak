#!/usr/bin/env python3
"""
AgentCaller - Claude Code 智能体调用器

功能：
- 集成 Claude Code 内置智能体
- 支持 general-purpose, Explore, Plan 等智能体类型
- 结果格式化和错误处理

注意：
此模块提供 Agent 调用的接口定义。实际执行时需要通过
Claude Code 环境调用 Task tool。在独立 Python 环境中，
本模块返回模拟结果或建议使用 Claude Code CLI。
"""

from typing import Dict, List, Optional, Any
from dataclasses import dataclass
from enum import Enum


class AgentType(Enum):
    """智能体类型"""
    GENERAL_PURPOSE = "general-purpose"
    EXPLORE = "Explore"
    PLAN = "Plan"


@dataclass
class AgentRequest:
    """智能体请求"""
    agent_type: AgentType
    prompt: str
    thoroughness: Optional[str] = None  # for Explore: quick/medium/very thorough
    model: Optional[str] = None


@dataclass
class AgentResult:
    """智能体执行结果"""
    agent_type: str
    prompt: str
    output: str
    success: bool
    agent_id: Optional[str] = None
    error: Optional[str] = None


class AgentCaller:
    """
    Claude Code 智能体调用器

    支持的智能体类型：
    - general-purpose: 复杂多步骤任务
    - Explore: 代码库探索和搜索
    - Plan: 实现计划设计
    """

    # 智能体使用建议
    AGENT_USAGE_GUIDE = {
        AgentType.GENERAL_PURPOSE: {
            "description": "通用智能体，适合复杂多步骤任务",
            "use_cases": [
                "代码搜索和理解",
                "多文件修改",
                "复杂问题分析",
            ],
            "tools": "所有工具（Read, Write, Edit, Bash, Grep, Glob等）"
        },
        AgentType.EXPLORE: {
            "description": "代码库探索专家，快速查找和理解代码",
            "use_cases": [
                "查找特定文件或模式",
                "搜索关键词",
                "理解代码库结构",
            ],
            "tools": "所有工具，优化用于探索"
        },
        AgentType.PLAN: {
            "description": "软件架构师，设计实现计划",
            "use_cases": [
                "规划实现策略",
                "识别关键文件",
                "架构权衡分析",
            ],
            "tools": "所有工具，侧重分析和规划"
        },
    }

    def __init__(self, claude_code_available: bool = False):
        """
        初始化智能体调用器

        Args:
            claude_code_available: Claude Code 环境是否可用
        """
        self.claude_code_available = claude_code_available

    def call_agent(self, request: AgentRequest) -> AgentResult:
        """
        调用智能体

        Args:
            request: AgentRequest对象

        Returns:
            AgentResult
        """
        if not self.claude_code_available:
            return self._simulate_agent_call(request)

        # 在 Claude Code 环境中，这里应该调用 Task tool
        # 由于我们无法直接从 Python 调用 Task tool，
        # 实际使用时需要通过 Claude Code CLI 或其他方式
        return self._suggest_claude_code_usage(request)

    def _simulate_agent_call(self, request: AgentRequest) -> AgentResult:
        """
        模拟智能体调用（用于测试）

        Args:
            request: AgentRequest对象

        Returns:
            AgentResult
        """
        guide = self.AGENT_USAGE_GUIDE.get(request.agent_type)

        simulated_output = f"""[模拟] {request.agent_type.value} 智能体

任务：{request.prompt}

说明：此为模拟输出。实际使用时需要在 Claude Code 环境中调用。

智能体信息：
- 描述：{guide['description'] if guide else 'N/A'}
- 适用场景：{', '.join(guide['use_cases']) if guide else 'N/A'}

建议：使用 Claude Code CLI 或 API 调用此智能体。
"""

        return AgentResult(
            agent_type=request.agent_type.value,
            prompt=request.prompt,
            output=simulated_output,
            success=True,
            agent_id="simulated-agent-id"
        )

    def _suggest_claude_code_usage(self, request: AgentRequest) -> AgentResult:
        """
        提供 Claude Code 使用建议

        Args:
            request: AgentRequest对象

        Returns:
            AgentResult
        """
        # 构建 Task tool 调用建议
        task_params = {
            "subagent_type": request.agent_type.value,
            "prompt": request.prompt,
            "description": f"Execute {request.agent_type.value} agent"
        }

        if request.agent_type == AgentType.EXPLORE and request.thoroughness:
            task_params["prompt"] = f"{request.prompt}\n\nThoroughness: {request.thoroughness}"

        if request.model:
            task_params["model"] = request.model

        suggestion = f"""Claude Code Task tool 调用建议：

Task tool 参数：
{task_params}

Python 代码示例（在 Claude Code 环境中）：
```python
# 注意：此代码仅在 Claude Code 环境中有效
result = task_tool(
    subagent_type="{request.agent_type.value}",
    prompt="{request.prompt}",
    description="Agent task"
)
```

CLI 使用示例：
```bash
# 通过 Claude Code 交互式会话
# 直接发送请求："{request.prompt}"
# Claude Code 会自动选择合适的智能体
```
"""

        return AgentResult(
            agent_type=request.agent_type.value,
            prompt=request.prompt,
            output=suggestion,
            success=False,
            error="Claude Code environment required for actual agent execution"
        )

    def suggest_agent_type(self, task_description: str) -> AgentType:
        """
        根据任务描述建议智能体类型

        Args:
            task_description: 任务描述

        Returns:
            推荐的 AgentType
        """
        task_lower = task_description.lower()

        # Explore 关键词
        if any(kw in task_lower for kw in ["查找", "搜索", "探索", "find", "search", "explore", "where"]):
            return AgentType.EXPLORE

        # Plan 关键词
        if any(kw in task_lower for kw in ["规划", "设计", "计划", "plan", "design", "architect"]):
            return AgentType.PLAN

        # 默认 general-purpose
        return AgentType.GENERAL_PURPOSE

    def get_agent_info(self, agent_type: AgentType) -> Dict[str, Any]:
        """
        获取智能体信息

        Args:
            agent_type: 智能体类型

        Returns:
            智能体信息字典
        """
        return self.AGENT_USAGE_GUIDE.get(agent_type, {})


# 使用示例
if __name__ == "__main__":
    caller = AgentCaller(claude_code_available=False)

    # 示例 1: 探索代码库
    explore_request = AgentRequest(
        agent_type=AgentType.EXPLORE,
        prompt="查找所有的认证相关代码",
        thoroughness="medium"
    )

    result = caller.call_agent(explore_request)
    print("=== Explore Agent ===")
    print(f"成功: {result.success}")
    print(f"输出:\n{result.output}")

    print("\n" + "="*60 + "\n")

    # 示例 2: 规划实现
    plan_request = AgentRequest(
        agent_type=AgentType.PLAN,
        prompt="设计一个用户权限系统的实现方案"
    )

    result = caller.call_agent(plan_request)
    print("=== Plan Agent ===")
    print(f"成功: {result.success}")
    print(f"输出:\n{result.output}")

    print("\n" + "="*60 + "\n")

    # 示例 3: 智能体类型建议
    task = "在代码库中找到所有的API端点定义"
    suggested_type = caller.suggest_agent_type(task)
    print(f"任务: {task}")
    print(f"建议智能体: {suggested_type.value}")
    print(f"智能体信息: {caller.get_agent_info(suggested_type)}")
