#!/usr/bin/env python3
"""
PromptManager - 提示词模板管理器

功能：
- 提示词模板库
- 变量替换
- 模板分类和检索
"""

from typing import Dict, List, Optional, Any
from dataclasses import dataclass
import re


@dataclass
class PromptTemplate:
    """提示词模板"""
    name: str
    category: str
    template: str
    variables: List[str]
    description: str


class PromptManager:
    """
    提示词模板管理器

    内置模板类别：
    - code-generation: 代码生成
    - code-review: 代码审查
    - documentation: 文档生成
    - analysis: 代码分析
    - refactoring: 重构建议
    - testing: 测试生成
    """

    # 内置模板库
    TEMPLATES = {
        "code-generation": PromptTemplate(
            name="code-generation",
            category="development",
            template="""你是一位经验丰富的软件工程师。请根据以下需求生成代码：

需求描述：
{requirement}

技术栈：{tech_stack}
编程语言：{language}

要求：
1. 代码遵循最佳实践
2. 包含必要的错误处理
3. 添加清晰的注释
4. 保持代码简洁易读

请生成完整的实现代码。""",
            variables=["requirement", "tech_stack", "language"],
            description="生成符合需求的代码实现"
        ),

        "code-review": PromptTemplate(
            name="code-review",
            category="quality",
            template="""你是一位资深代码审查专家。请审查以下代码：

```{language}
{code}
```

请从以下维度进行审查：
1. 代码质量：可读性、可维护性
2. 性能：是否有性能瓶颈
3. 安全：是否存在安全隐患
4. 最佳实践：是否符合行业规范

请提供具体的改进建议。""",
            variables=["code", "language"],
            description="全面审查代码质量和安全性"
        ),

        "documentation": PromptTemplate(
            name="documentation",
            category="documentation",
            template="""你是一位技术文档专家。请为以下代码生成文档：

```{language}
{code}
```

文档类型：{doc_type}

要求：
1. 清晰描述功能和用途
2. 说明参数和返回值
3. 提供使用示例
4. 注明注意事项

请生成{doc_format}格式的文档。""",
            variables=["code", "language", "doc_type", "doc_format"],
            description="生成专业的技术文档"
        ),

        "bug-analysis": PromptTemplate(
            name="bug-analysis",
            category="debugging",
            template="""你是一位调试专家。请分析以下bug：

错误描述：
{error_description}

相关代码：
```{language}
{code}
```

错误信息：
{error_message}

请提供：
1. Bug根因分析
2. 修复建议
3. 预防措施
4. 测试建议""",
            variables=["error_description", "code", "language", "error_message"],
            description="分析和修复代码bug"
        ),

        "refactoring": PromptTemplate(
            name="refactoring",
            category="optimization",
            template="""你是一位重构专家。请对以下代码提出重构建议：

```{language}
{code}
```

关注点：{focus_areas}

要求：
1. 识别代码异味
2. 提出重构方案
3. 说明重构收益
4. 提供重构后的代码示例

请保持功能不变的前提下优化代码结构。""",
            variables=["code", "language", "focus_areas"],
            description="提供代码重构建议"
        ),

        "test-generation": PromptTemplate(
            name="test-generation",
            category="testing",
            template="""你是一位测试工程师。请为以下代码生成测试用例：

```{language}
{code}
```

测试框架：{test_framework}
测试类型：{test_type}

要求：
1. 覆盖正常路径
2. 覆盖边界条件
3. 覆盖异常情况
4. 包含测试数据准备和清理

请生成完整的测试代码。""",
            variables=["code", "language", "test_framework", "test_type"],
            description="生成全面的测试用例"
        ),

        "api-design": PromptTemplate(
            name="api-design",
            category="design",
            template="""你是一位API设计专家。请设计以下功能的API：

功能需求：
{requirement}

API风格：{api_style}
数据格式：{data_format}

要求：
1. RESTful设计原则
2. 清晰的端点命名
3. 合理的HTTP方法选择
4. 完整的错误处理
5. 请求/响应示例

请提供完整的API设计文档。""",
            variables=["requirement", "api_style", "data_format"],
            description="设计RESTful API接口"
        ),

        "performance-optimization": PromptTemplate(
            name="performance-optimization",
            category="optimization",
            template="""你是一位性能优化专家。请优化以下代码的性能：

```{language}
{code}
```

性能指标：{performance_metrics}
优化目标：{optimization_goal}

要求：
1. 识别性能瓶颈
2. 提出优化方案
3. 说明预期收益
4. 提供优化后的代码

请在保证正确性的前提下优化性能。""",
            variables=["code", "language", "performance_metrics", "optimization_goal"],
            description="优化代码性能"
        ),
    }

    def __init__(self):
        """初始化提示词管理器"""
        self.templates = self.TEMPLATES.copy()

    def get_template(self, name: str) -> Optional[PromptTemplate]:
        """
        获取模板

        Args:
            name: 模板名称

        Returns:
            PromptTemplate或None
        """
        return self.templates.get(name)

    def list_templates(self, category: Optional[str] = None) -> List[PromptTemplate]:
        """
        列出所有模板

        Args:
            category: 可选的类别筛选

        Returns:
            模板列表
        """
        if category:
            return [t for t in self.templates.values() if t.category == category]
        return list(self.templates.values())

    def render(self, template_name: str, **variables) -> Optional[str]:
        """
        渲染模板

        Args:
            template_name: 模板名称
            **variables: 模板变量

        Returns:
            渲染后的提示词，失败返回None
        """
        template = self.get_template(template_name)
        if not template:
            return None

        # 检查必需变量
        missing_vars = set(template.variables) - set(variables.keys())
        if missing_vars:
            # 使用默认值填充缺失变量
            for var in missing_vars:
                variables[var] = f"[{var}]"

        # 渲染模板
        try:
            rendered = template.template.format(**variables)
            return rendered
        except KeyError as e:
            return None

    def add_template(self, template: PromptTemplate):
        """
        添加自定义模板

        Args:
            template: PromptTemplate对象
        """
        self.templates[template.name] = template

    def search_templates(self, keyword: str) -> List[PromptTemplate]:
        """
        搜索模板

        Args:
            keyword: 搜索关键词

        Returns:
            匹配的模板列表
        """
        results = []
        keyword_lower = keyword.lower()

        for template in self.templates.values():
            if (keyword_lower in template.name.lower() or
                keyword_lower in template.description.lower() or
                keyword_lower in template.category.lower()):
                results.append(template)

        return results

    def get_categories(self) -> List[str]:
        """
        获取所有模板类别

        Returns:
            类别列表
        """
        return list(set(t.category for t in self.templates.values()))


# 使用示例
if __name__ == "__main__":
    manager = PromptManager()

    # 列出所有模板
    print("可用模板：")
    for template in manager.list_templates():
        print(f"  - {template.name}: {template.description}")

    print("\n" + "="*60)

    # 渲染代码生成模板
    prompt = manager.render(
        "code-generation",
        requirement="实现用户登录功能",
        tech_stack="Flask + SQLAlchemy",
        language="Python"
    )

    if prompt:
        print("生成的提示词：")
        print(prompt)

    print("\n" + "="*60)

    # 搜索测试相关模板
    test_templates = manager.search_templates("test")
    print(f"\n测试相关模板：{len(test_templates)}个")
    for t in test_templates:
        print(f"  - {t.name}")
