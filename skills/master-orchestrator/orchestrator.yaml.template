# Orchestrator V3 配置文件模板
# 版本: 3.1 (支持 Slash Commands + 自动发现 + 注册表缓存)
#
# ============================================================================
# V3.1 新特性
# ============================================================================
# 1. 自动资源发现 (Auto-Discovery)
#    - 自动扫描 skills/、agents/、commands/、prompts/ 目录
#    - 支持 SKILL.md、AGENT.md、COMMAND.md、PROMPT.md 标记文件
#    - 三层配置优先级: project > user > builtin
#
# 2. 注册表持久化 (Registry Persistence) - 自动启用
#    - 缓存扫描结果到 ~/.memex/orchestrator/registry/
#    - 文件哈希校验，自动检测变更
#    - TTL 过期机制，默认 1 小时
#    - 显著提升启动速度
#    - 注意: 当前硬编码，暂不支持配置文件自定义
#
# 3. 扫描统计合并
#    - 合并 user 和 project 两次扫描的统计信息
#    - 提供详细的资源来源追踪
#
# 4. Git 项目根目录检测
#    - 自动检测 git 仓库根目录作为项目根
#    - 支持手动指定 project_root
#
# 5. 增强的配置对象
#    - CommandConfig、AgentConfig、PromptConfig 新增 path 字段
#    - 支持更精确的资源定位和管理
#
# 6. 配置模板清理
#    - 移除未实现的配置节（logging, cache, security）
#    - 移除未使用的 auto_discovery 子配置（scan_user, scan_project）
#    - 模板仅包含实际支持的配置项
#
# 7. 并行配置支持 (V3.1)
#    - parallel 配置现在从配置文件读取
#    - 优先级: 配置文件 > 构造函数参数
#    - 支持 enabled, max_workers, timeout_per_task
# ============================================================================

version: "3.1"

# ============================================================================
# 全局配置
# ============================================================================
global:
  # 默认超时 (秒)
  timeout: 300

  # 是否启用资源自动发现（推荐开启）
  enable_auto_discovery: true

  # 项目根目录（空值则自动检测 git 仓库根目录）
  project_root: null

  # 注册表缓存有效期（秒），默认 3600 秒（1小时）
  cache_ttl: 3600

  # aduib-ai 服务配置（优先级: 环境变量 > 配置文件 > 构造函数参数）
  aduib_url: null  # aduib-ai 服务地址，空值则使用环境变量 ADUIB_URL
  aduib_api_key: null  # aduib-ai API 密钥，空值则使用环境变量 ADUIB_API_KEY

# ============================================================================
# Slash Command 配置 (V3.1 新增)
# ============================================================================
slash_commands:
  # 是否启用自定义 Slash Commands
  enabled: true

  # 自定义系统命令
  system:
    # 示例: 自定义状态命令
    - name: my-stats
      description: "显示自定义统计信息"
      handler: "_get_stats"  # MasterOrchestrator 中的方法
      enabled: true
      priority: 80  # 低于内置命令 (100)
      examples:
        - "/my-stats"

  # 自定义 Shell 命令
  shell:
    # 示例: 自定义 git 命令
    - name: gst
      description: "Git status 简写"
      command: "git status -sb"
      enabled: true
      priority: 60
      examples:
        - "/gst"

    - name: glog
      description: "Git log with graph"
      command: "git log --oneline --graph -10"
      enabled: true
      priority: 60
      examples:
        - "/glog"
        - "/glog -20"

    # 示例: 项目构建命令
    - name: build
      description: "运行项目构建"
      command: "npm run build"
      enabled: true
      priority: 70
      examples:
        - "/build"

    - name: test
      description: "运行所有测试"
      command: "pytest tests/"
      enabled: true
      priority: 70
      examples:
        - "/test"
        - "/test -v"

  # 自定义 Skill 命令
  skill:
    # 示例: 代码审查
    - name: review
      description: "代码审查当前分支"
      skill: "code-review"  # skills/ 目录下的 skill
      enabled: true
      priority: 80
      examples:
        - "/review"
        - "/review path/to/file.py"

    # 示例: 生成文档
    - name: gendoc
      description: "生成API文档"
      skill: "api-document-generator"
      enabled: true
      priority: 80
      examples:
        - "/gendoc src/"

  # 自定义 Agent 命令
  agent:
    # 示例: 快速探索
    - name: explore
      description: "探索代码库"
      agent_type: "EXPLORE"
      thoroughness: "medium"
      enabled: true
      priority: 75
      examples:
        - "/explore auth system"

    - name: plan
      description: "规划实现方案"
      agent_type: "PLAN"
      enabled: true
      priority: 75
      examples:
        - "/plan add user authentication"

  # 自定义 Prompt 模板命令
  prompt:
    # 示例: API 文档模板
    - name: apidoc
      description: "生成API文档模板"
      prompt_template: "api-doc"
      enabled: true
      priority: 60
      examples:
        - "/apidoc MyClass"

# ============================================================================
# Skills 配置
# ============================================================================
skills:
  # 自动发现配置 (V3.1)
  # 当 global.enable_auto_discovery=true 时，自动扫描以下目录：
  # - ~/.claude/skills/       (User level)
  # - .claude/skills/          (Project level)
  # - skills/                  (Builtin level)
  #
  # 支持的 Skill 结构：
  # 1. SKILL.md 标记文件 (推荐)
  # 2. skill.yaml 配置文件
  # 3. Python 入口 (*.py)
  #
  # 扫描优先级: project > user > builtin
  # 注意: 自动发现通过 global.enable_auto_discovery 控制，无需额外配置

  # Skills 扫描路径 (仅用于 enable_auto_discovery=false 时)
  scan_paths:
    - ./skills/*.yaml
    - ./skills/*/*.yaml
    - ~/.claude/skills/*.yaml

  # 手动注册 Skills（覆盖自动发现的同名资源）
  manual:
    - name: code-review
      path: ./skills/code-review/skill.yaml
      enabled: true
      priority: 100  # 高优先级覆盖自动发现

    - name: api-document-generator
      path: ./skills/api-document-generator/skill.yaml
      enabled: true
      priority: 100

    - name: dev-workflow
      path: ./skills/dev-workflow-agent/skill.yaml
      enabled: true
      priority: 100

# ============================================================================
# Commands 配置 (Shell 命令白名单)
# ============================================================================
commands:
  # 允许的命令白名单
  whitelist:
    - git
    - npm
    - python
    - pytest
    - pip
    - node
    - yarn
    - docker
    - kubectl

  # 危险命令黑名单 (总是拒绝)
  blacklist:
    - rm
    - dd
    - mkfs
    - iptables
    - reboot
    - shutdown

  # 命令别名
  aliases:
    - name: gst
      command: git status
    - name: glog
      command: git log --oneline -10
    - name: gd
      command: git diff

# ============================================================================
# Agents 配置
# ============================================================================
agents:
  # 自动发现配置 (V3.1)
  # 当 global.enable_auto_discovery=true 时，自动扫描包含 AGENT.md 标记的目录：
  # - agents/*/AGENT.md
  # - .claude/agents/*/AGENT.md
  # 注意: 自动发现通过 global.enable_auto_discovery 控制，无需额外配置

  # 默认 Agent 配置
  default:
    model: claude-3-5-sonnet-20241022
    temperature: 0.3
    max_tokens: 4000

  # 特定 Agent 配置
  explore:
    model: claude-3-5-sonnet-20241022
    thoroughness: medium

  plan:
    model: claude-3-5-sonnet-20241022
    max_tokens: 8000

# ============================================================================
# Prompts 配置
# ============================================================================
prompts:
  # 自动发现配置 (V3.1)
  # 当 global.enable_auto_discovery=true 时，自动扫描包含 PROMPT.md 标记的目录：
  # - prompts/*/PROMPT.md
  # - .claude/prompts/*/PROMPT.md
  # 注意: 自动发现通过 global.enable_auto_discovery 控制，无需额外配置

  # 自定义 Prompt 模板
  templates:
    - name: custom-review
      category: code-review
      template: |
        请审查以下代码:

        {code}

        重点关注: {focus_areas}
      variables:
        - code
        - focus_areas
      description: "自定义代码审查模板"

# ============================================================================
# 并行执行配置 (V3.1 已支持)
# ============================================================================
parallel:
  # 是否启用并行执行
  enabled: false

  # 最大并行任务数
  max_workers: 3

  # 每个任务的超时时间 (秒)
  timeout_per_task: 120

# ============================================================================
# 注册表持久化 (V3.1)
# ============================================================================
# 注意: Registry 配置当前硬编码在代码中，暂不支持通过配置文件修改
# 默认配置:
#   - 目录: ~/.memex/orchestrator/registry
#   - TTL: 3600 秒 (1 小时)
#   - 自动启用
#   - 文件修改后自动失效
#
# 清理缓存:
#   删除 ~/.memex/orchestrator/registry/ 目录下的文件

# ============================================================================
# 使用指南
# ============================================================================
#
# 1. 启用自动发现 (推荐)
#    设置 global.enable_auto_discovery: true
#    自动扫描目录，无需手动配置每个资源
#
# 2. 目录结构推荐
#    项目级别:
#      .claude/
#        ├── skills/           # 项目专属 skills
#        ├── agents/           # 项目专属 agents
#        ├── commands/         # 项目专属 slash commands
#        └── prompts/          # 项目专属 prompts
#
#    用户级别:
#      ~/.claude/
#        ├── skills/           # 用户全局 skills
#        ├── agents/           # 用户全局 agents
#        └── prompts/          # 用户全局 prompts
#
# 3. 资源标记文件
#    在资源目录中创建标记文件:
#    - SKILL.md    (标识 Skill)
#    - AGENT.md    (标识 Agent)
#    - COMMAND.md  (标识 Command)
#    - PROMPT.md   (标识 Prompt)
#
# 4. 优先级规则
#    - project (100) > user (50) > builtin (10)
#    - 手动配置的资源优先级可自定义
#    - 高优先级资源覆盖低优先级同名资源
#
# 5. 注册表缓存 (自动启用)
#    - 首次扫描后自动缓存到 ~/.memex/orchestrator/registry/
#    - 文件修改自动失效重新扫描
#    - TTL: 3600 秒 (1 小时)
#    - 清理缓存: 删除 last_scan.json 和 resources_snapshot.json
#
# 6. 调试技巧
#    - 使用 --verbose 或 -v 查看详细日志
#    - 使用 --dry-run 或 -n 预览执行计划
#    - 检查扫描统计: Auto-discovered: X skills, Y commands...
#
# ============================================================================
