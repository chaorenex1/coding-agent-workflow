# 快速重构工作流 - README

## 概述

快速重构工作流是一个系统化的代码质量改进工具,通过多个智能体协作,帮助程序员安全、高效地完成代码重构。本文档为程序员提供重构参考指南。

## 目录

1. [快速开始](#快速开始)
2. [工作流概览](#工作流概览)
3. [智能体介绍](#智能体介绍)
4. [使用指南](#使用指南)
5. [输出文档说明](#输出文档说明)
6. [最佳实践](#最佳实践)
7. [常见问题](#常见问题)

---

## 快速开始

### 基本用法

```bash
/quick-refactor <CODE_SCOPE>
```

### 示例

```bash
# 重构单个文件
/quick-refactor src/services/UserManager.ts

# 重构整个目录
/quick-refactor src/modules/orders

# 只处理严重问题
/quick-refactor src/services --priority P0

# 安全模式(每步确认)
/quick-refactor src/utils --safe-mode
```

### 选项参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--priority <LEVEL>` | 指定优先级(P0/P1/P2/P3) | `--priority P0` |
| `--skip-analysis` | 跳过分析,使用已有报告 | `--skip-analysis` |
| `--skip-validation` | 跳过验证(不推荐) | `--skip-validation` |
| `--safe-mode` | 每步人工确认 | `--safe-mode` |
| `--auto-commit` | 每步自动提交(默认) | `--auto-commit` |
| `--batch-commit` | 批量提交 | `--batch-commit` |

---

## 工作流概览

### 流程图

```
┌─────────────────────────────────────────────────────────┐
│                     快速重构工作流                        │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌──────────────────────────────────┐
        │  阶段0: 环境准备 (自动)           │
        │  - 检查工作区                     │
        │  - 运行基线测试                   │
        │  - 记录基线指标                   │
        └───────────────┬──────────────────┘
                        │
                        ▼
        ┌──────────────────────────────────┐
        │  阶段1: 重构分析 (交互)           │
        │  - 检测代码异味                   │
        │  - 评定优先级                     │
        │  - 制定策略                       │
        │  - 风险评估                       │
        └───────────────┬──────────────────┘
                        │
                   ✋ 用户确认优先级
                        │
                        ▼
        ┌──────────────────────────────────┐
        │  阶段2: 生成执行计划 (自动)       │
        │  - 排序步骤                       │
        │  - 定义检查点                     │
        │  - 准备回滚策略                   │
        └───────────────┬──────────────────┘
                        │
                   ✋ 用户确认计划
                        │
                        ▼
        ┌──────────────────────────────────┐
        │  阶段3: 执行重构 (自动)           │
        │  - 小步迭代                       │
        │  - 持续测试                       │
        │  - 及时提交                       │
        │  - 失败回滚                       │
        └───────────────┬──────────────────┘
                        │
                        ▼
        ┌──────────────────────────────────┐
        │  阶段4: 验证重构 (自动)           │
        │  - 测试验证                       │
        │  - 质量对比                       │
        │  - 性能检查                       │
        │  - 兼容性验证                     │
        └───────────────┬──────────────────┘
                        │
                        ▼
        ┌──────────────────────────────────┐
        │  阶段5: 交付文档 (自动)           │
        │  - 生成报告                       │
        │  - 更新文档                       │
        │  - 整理提交                       │
        └──────────────────────────────────┘
```

### 阶段说明

| 阶段 | 目标 | 耗时 | 智能体 |
|------|------|------|--------|
| 0 | 确保环境安全可靠 | 2-5分钟 | 无 |
| 1 | 识别问题并制定计划 | 3-10分钟 | 重构分析师 |
| 2 | 生成可执行步骤 | 1-3分钟 | 协调者 |
| 3 | 安全执行重构操作 | 30分钟-16小时 | 重构执行者 |
| 4 | 验证正确性和质量 | 3-10分钟 | 重构验证者 |
| 5 | 生成交付文档 | 2-5分钟 | 协调者 |

---

## 智能体介绍

### 1. 重构分析师 (Refactor Analyzer)

**职责**: 代码质量评估和重构策略制定

**核心能力**:
- 识别代码异味(神类、长方法、重复代码等)
- 评估技术债务严重程度
- 制定分步重构计划
- 评估重构风险

**输出文档**:
- `refactor-analysis.md` - 完整分析报告

**关键指标**:
- 代码异味分类统计
- 优先级分布
- 预估工作量
- 风险评级

### 2. 重构执行者 (Refactor Executor)

**职责**: 安全执行代码重构操作

**核心能力**:
- 应用重构技术(提取方法、提取类、引入策略等)
- 小步迭代执行
- 自动运行测试
- 失败自动回滚

**支持的重构技术**:
- 提取方法 (Extract Method)
- 提取类 (Extract Class)
- 引入参数对象 (Introduce Parameter Object)
- 替换算法 (Substitute Algorithm)
- 引入策略模式 (Strategy Pattern)
- 消除重复代码

**安全机制**:
- 每步后运行测试
- 测试失败自动回滚
- 独立git提交
- 保持代码可编译

### 3. 重构验证者 (Refactor Validator)

**职责**: 多维度验证重构质量

**验证维度**:
1. **测试验证**: 单元测试、集成测试、覆盖率
2. **质量验证**: 代码异味、复杂度、风格
3. **架构验证**: SOLID原则、模块耦合、依赖关系
4. **性能验证**: 基准测试、响应时间、资源使用
5. **兼容性验证**: API兼容、数据兼容、配置兼容
6. **文档验证**: 注释、API文档、变更日志

**输出文档**:
- `refactor-validation.md` - 完整验证报告
- 包含所有指标对比和验证结论

---

## 使用指南

### 场景1: 首次使用 - 处理严重问题

```bash
# 1. 分析整个项目的严重问题
/quick-refactor src --priority P0

# 2. 查看分析报告
cat ./.claude/refactor/analysis/refactor-analysis.md

# 3. 确认优先级选择(选择1: 仅P0)

# 4. 审查执行计划
cat ./.claude/refactor/plan/execution-plan.md

# 5. 确认开始执行

# 6. 等待执行完成(自动进行)

# 7. 查看验证报告
cat ./.claude/refactor/validation/refactor-validation.md

# 8. 如果通过,合并分支
git checkout main
git merge refactor/20251125-quality-improvement
```

### 场景2: 重构单个文件 - 使用安全模式

```bash
# 1. 启动重构(安全模式)
/quick-refactor src/services/UserManager.ts --safe-mode

# 2. 查看分析报告并选择优先级

# 3. 审查执行计划并确认

# 4. 执行步骤1,查看变更
# (系统会暂停等待确认)

# 5. 确认无误,继续下一步
# 输入: yes

# 6. 重复步骤4-5直到完成

# 7. 查看验证报告并决定是否合并
```

### 场景3: 快速清理技术债务

```bash
# 1. 分析并处理P0和P1问题
/quick-refactor src/modules/orders --priority P0+P1

# 2. 选择优先级: 2 (P0 + P1)

# 3. 确认计划并开始执行

# 4. 等待完成(可能需要几小时)

# 5. 查看改进效果
cat ./.claude/refactor/summary.md
```

### 场景4: 处理已分析的代码

```bash
# 如果之前已经运行过分析
/quick-refactor src --skip-analysis --priority P1

# 系统会复用上次的分析报告
# 只处理P1优先级的问题
```

---

## 输出文档说明

### 目录结构

```
./.claude/refactor/
├── baseline-metrics.json              # 重构前的基线指标
├── analysis/
│   └── refactor-analysis.md           # 📊 重构分析报告(核心)
├── plan/
│   └── execution-plan.md              # 📋 执行计划(核心)
├── execution/
│   ├── step-1-log.md                  # 步骤1执行日志
│   ├── step-2-log.md                  # 步骤2执行日志
│   └── ...
├── validation/
│   ├── refactor-validation.md         # ✅ 验证报告(核心)
│   ├── test-results.txt               # 测试详细结果
│   ├── coverage-report.html           # 覆盖率HTML报告
│   └── metrics-comparison.json        # 指标对比数据
└── summary.md                         # 📄 重构总结(核心)
```

### 核心文档解读

#### 1. 重构分析报告 (refactor-analysis.md)

**内容结构**:
```markdown
# 重构分析报告

## 执行摘要
- 代码健康度评分
- 问题统计
- 主要问题清单
- 预估工作量
- 风险评估

## 代码异味详细分析
- 🔴 严重异味(P0)
  - 问题描述
  - 影响分析
  - 重构建议
  - 优先级和工作量
- 🟠 高优先级异味(P1)
- 🟡 中优先级异味(P2)
- 🟢 低优先级异味(P3)

## 设计改进建议
- 应用设计模式建议
- 架构优化建议

## 重构路线图
- 第一阶段: 紧急修复
- 第二阶段: 性能优化
- 第三阶段: 代码清理
- 第四阶段: 持续改进

## 风险评估与缓解
- 风险矩阵
- 前置条件检查
- 回滚策略

## 成功指标
- 量化目标
- 质量指标
```

**如何使用**:
1. 先看执行摘要,了解整体情况
2. 查看问题清单,理解具体问题
3. 阅读重构建议,学习重构方法
4. 参考路线图,规划重构顺序

#### 2. 执行计划 (execution-plan.md)

**内容结构**:
```markdown
# 重构执行计划

## 计划概览
- 总步骤数
- 总预估时间
- 优先级范围

## 步骤清单
步骤1: [步骤名称]
  - 目标
  - 操作
  - 验证方式
  - 预估时间
  - 依赖关系

步骤2: ...

## 依赖关系图
- 可视化步骤依赖

## 回滚策略
- 每步的回滚方法
```

**如何使用**:
1. 查看总体时间预估,规划工作时间
2. 理解每步的目标和操作
3. 注意依赖关系,了解执行顺序
4. 熟悉回滚策略,做好应急准备

#### 3. 验证报告 (refactor-validation.md)

**内容结构**:
```markdown
# 重构验证报告

## 执行摘要
- 总体结论(通过/有条件通过/不通过)
- 关键发现

## 测试验证结果
- 单元测试: 通过率、新增/修改测试
- 集成测试: 关键场景验证
- 覆盖率: 前后对比

## 代码质量验证
- 代码异味消除统计
- 复杂度改善数据
- 代码风格检查结果

## 架构质量验证
- SOLID原则符合度
- 模块耦合度分析
- 循环依赖检查

## 性能验证
- 基准测试结果
- 响应时间对比
- 资源使用分析

## 兼容性验证
- API兼容性检查
- 数据兼容性确认
- 配置兼容性验证

## 改进效果总结
- 量化改进表格
- 定性改进描述

## 验证结论
- 总体评估
- 发布建议
- 后续行动
```

**如何使用**:
1. 先看执行摘要,了解是否通过验证
2. 查看测试结果,确认功能正确性
3. 查看改进效果,评估重构价值
4. 根据建议决定是否合并和发布

#### 4. 重构总结 (summary.md)

**内容结构**:
```markdown
# 重构总结报告

## 基本信息
- 重构范围
- 执行时间
- 参与智能体

## 执行过程
- 各步骤执行情况
- 遇到的问题和解决方案

## 变更统计
- 文件变更统计
- 代码行数统计
- 提交历史

## 质量改进
- 指标对比表格
- 改进百分比

## 经验总结
- 成功经验
- 改进建议
- 注意事项

## 后续建议
- 立即执行事项
- 短期计划
- 长期规划
```

**如何使用**:
1. 作为重构工作的完整记录
2. 分享给团队成员了解重构内容
3. 作为类似重构的参考案例
4. 记录经验教训,避免重复问题

---

## 最佳实践

### 1. 重构前的准备

```bash
# ✅ 推荐做法
# 1. 确保工作区干净
git status
git stash  # 如果有未提交变更

# 2. 确保在最新代码上工作
git pull origin main

# 3. 创建备份分支
git branch backup-before-refactor

# 4. 运行完整测试
npm test
npm run test:integration

# 5. 记录当前状态
npm run test:coverage > baseline-coverage.txt
npm run lint > baseline-lint.txt
```

### 2. 选择合适的优先级

| 场景 | 推荐优先级 | 理由 |
|------|-----------|------|
| 首次重构 | P0 | 建立信心,快速见效 |
| 生产问题修复后 | P0 + P1 | 防止问题再发生 |
| 常规重构 | P0 + P1 + P2 | 全面改善代码质量 |
| 完整清理 | 全部 | 彻底清理技术债务 |
| 时间紧急 | P0 | 只处理最关键问题 |

### 3. 重构中的监控

```bash
# 监控进度
watch -n 5 'git log --oneline -10'

# 监控测试状态
watch -n 10 'npm test'

# 监控资源使用
htop  # Linux
top   # macOS
```

### 4. 重构后的验证

```bash
# 1. 本地完整验证
npm run build
npm test
npm run test:integration
npm run lint
npm run type-check

# 2. 查看代码变更
git diff main

# 3. 查看提交历史
git log --oneline main..HEAD

# 4. 在测试环境部署验证
# (具体命令根据项目而定)
```

### 5. 团队协作

```bash
# 1. 推送重构分支
git push origin refactor/20251125-quality-improvement

# 2. 创建Pull Request
# (在GitHub/GitLab界面操作)

# 3. 在PR描述中包含:
# - 重构目标
# - 主要改动
# - 测试结果
# - 验证报告链接

# 4. 请求代码审查
# @teammate1 @teammate2

# 5. 合并后通知团队
# (Slack/邮件/站会)
```

---

## 常见问题

### Q1: 什么时候应该使用快速重构?

**A**: 适用于以下场景:
- 代码质量下降,需要改善
- 发现明显的代码异味
- 技术债务积累过多
- 维护困难,需要重构
- 性能问题需要优化

**不适用**:
- 开发新功能(使用 `/quick-feature`)
- 修复具体bug(使用 `/bugfix`)
- 大规模重写项目

### Q2: 重构会破坏现有功能吗?

**A**: 不会。快速重构工作流有多重安全保障:
1. 每步都运行测试验证
2. 测试失败自动回滚
3. 独立分支隔离
4. 完整的验证机制
5. 向后兼容性检查

只要测试覆盖充分,重构是安全的。

### Q3: 重构需要多长时间?

**A**: 取决于代码复杂度和问题数量:
- 简单重构(单个文件,问题<5个): 30-60分钟
- 中等重构(多个文件,问题5-20个): 2-4小时
- 复杂重构(跨模块,问题>20个): 8-16小时

分析报告会提供准确的时间预估。

### Q4: 测试覆盖率低怎么办?

**A**: 建议:
1. 先补充测试用例,达到80%以上
2. 或者使用 `--safe-mode`,每步人工检查
3. 或者只处理低风险的P3问题

不推荐在测试不足时进行大规模重构。

### Q5: 执行步骤失败怎么处理?

**A**: 系统会自动回滚失败的步骤。你可以:
1. 查看错误信息和失败原因
2. 手动修复问题后重新执行
3. 跳过该步骤,继续其他步骤
4. 暂停重构,寻求帮助

每步都是独立的,不会影响已完成的步骤。

### Q6: 可以暂停重构吗?

**A**: 可以。因为每步都有独立提交:
1. 随时按 Ctrl+C 中断
2. 已完成的步骤会保留
3. 下次可以从中断处继续
4. 或者使用 `git reset` 回到任何提交点

### Q7: 如何评估重构效果?

**A**: 查看验证报告中的指标对比:
- 代码复杂度是否降低
- 代码异味是否减少
- 测试覆盖率是否提升
- 模块耦合度是否降低
- 性能是否稳定或改善

### Q8: 重构后需要更新文档吗?

**A**: 系统会自动:
- 更新代码注释
- 生成变更日志
- 更新API文档

但你可能还需要:
- 更新用户文档
- 通知团队成员
- 更新架构图(如有大变更)

### Q9: 可以自定义重构策略吗?

**A**: 目前智能体会基于最佳实践自动制定策略。如果需要自定义:
1. 查看分析报告中的建议
2. 使用 `--safe-mode` 手动控制每步
3. 或者先生成计划,手动调整后执行

### Q10: 重构会影响性能吗?

**A**: 通常不会,甚至可能改善性能:
- 优化算法和数据结构
- 消除重复计算
- 改善缓存策略
- 优化数据库查询

验证报告会包含性能对比数据。

---

## 进阶主题

### 自定义重构技术

如果需要应用特定的重构技术,可以:
1. 先使用快速重构生成分析报告
2. 手动编辑执行计划,指定重构方法
3. 使用 `--skip-analysis` 复用分析结果

### 批量重构

对于多个类似的重构任务:
```bash
# 逐个处理
/quick-refactor src/services/UserService.ts
/quick-refactor src/services/OrderService.ts
/quick-refactor src/services/ProductService.ts

# 或统一处理
/quick-refactor src/services --priority P1
```

### 集成到CI/CD

可以将重构验证集成到CI流程:
```yaml
# .github/workflows/refactor-validation.yml
name: Refactor Validation
on: [pull_request]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm test
      - run: npm run lint
      - run: npm run complexity-check
```

---

## 相关资源

### 推荐阅读

- 《重构:改善既有代码的设计》 - Martin Fowler
- 《代码整洁之道》 - Robert C. Martin
- 《设计模式》 - GoF
- 《重构手册》 - Kent Beck

### 工具推荐

- **代码质量**: SonarQube, ESLint, TSLint
- **复杂度分析**: complexity-report, plato
- **依赖分析**: madge, dependency-cruiser
- **性能测试**: benchmark.js, autocannon

### 社区交流

如有问题或建议,欢迎通过以下方式交流:
- GitHub Issues
- 团队Slack频道
- 技术分享会

---

## 总结

快速重构工作流是一个强大的代码质量改进工具,通过:
- 🛡️ **多重安全保障**确保不破坏功能
- 🎯 **智能分析**精准识别问题
- 🤖 **自动化执行**提高效率
- ✅ **全面验证**保证质量
- 📚 **完整文档**便于追溯

希望这个工具能帮助你持续改善代码质量,享受编码的乐趣! 🚀

---

**版本**: 1.0.0  
**更新日期**: 2025-11-25  
**维护者**: Coding Agent Workflow Team
