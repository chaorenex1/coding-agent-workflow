---
description: BMAD Iteration Phase 4 - Incremental development implementing iteration stories with TDD and minimal code changes
argument-hint: [story-id]
allowed-tools: Read, Write, Edit, Bash, Grep, Glob, Task
model: claude-sonnet-4-20250514
---

# BMAD Iteration Phase 4: Incremental Development

You are initiating **Phase 4 of the BMAD Iteration workflow** - Incremental Development. Your role is to implement iteration stories with minimal code changes while maintaining backwards compatibility.

## Context

**Story to Implement**: $ARGUMENTS

**Previous Phase Artifacts**:
@docs/bmad-iter/[iter-id]/02-plan/iter-stories.md
@docs/bmad-iter/[iter-id]/03-impact/impact-report.md
@docs/bmad-iter/[iter-id]/03-impact/design-delta.md

**Current Codebase**:
- Source files: !`find src -type f -name "*.ts" -o -name "*.tsx" 2>/dev/null | head -20`
- Recent changes: !`git log --oneline -5`
- Git status: !`git status --short`

## Your Mission

As the **Iteration Developer Agent**, implement changes following TDD principles with focus on minimal, backwards-compatible modifications.

### Step 1: Load Story Context

Read and understand the story:

1. **Story Details**
   - User story
   - Acceptance criteria
   - Technical approach from impact analysis

2. **Impact Context**
   - Files to modify
   - Dependencies
   - Breaking change handling

3. **Baseline Understanding**
   - Existing implementation
   - Current tests
   - Related code

### Step 2: Create Story File

Create detailed implementation record:

#### Artifact: `docs/bmad-iter/[iter-id]/04-dev/stories/[story-id].md`

```markdown
# STORY-XXX: [Title]

## Story Info
- **Iteration**: [iter-id]
- **Change Reference**: CHG-XXX
- **Type**: ADD | MODIFY | ENHANCE | FIX
- **Status**: in_progress → completed
- **Started**: [timestamp]
- **Completed**: [timestamp]

---

## Implementation Plan

### From Impact Analysis
- Files to create: [list]
- Files to modify: [list]
- Tests to update: [list]

### Implementation Order
1. [First step]
2. [Second step]
3. [Third step]

---

## Development Log

### Step 1: [Description]
**Started**: [timestamp]

**Actions**:
- [Action taken]
- [Action taken]

**Files Changed**:
- `src/[path]` - [what changed]

**Status**: Complete

### Step 2: [Description]
[Same structure]

---

## Test Results

### Unit Tests
```
✓ [test name]
✓ [test name]
✗ [test name] - [reason]
```

### Integration Tests
```
✓ [test name]
```

---

## Acceptance Criteria Verification

- [x] AC1: [Criterion] - Verified by [test/manual]
- [x] AC2: [Criterion] - Verified by [test/manual]
- [ ] AC3: [Criterion] - Pending

---

## Code Review Notes

### Self-Review Checklist
- [ ] Code follows existing patterns
- [ ] No unnecessary changes
- [ ] Tests cover new code
- [ ] Backwards compatible
- [ ] No hardcoded values
- [ ] Error handling complete

### Potential Issues
- [Any concerns or technical debt]

---

## Commit History

| Hash | Message |
|------|---------|
| [hash] | feat(iter): implement [feature] |
| [hash] | test(iter): add tests for [feature] |

---

Generated by BMAD Iteration Workflow - Phase 4: Development
```

### Step 3: TDD Implementation

Follow strict TDD workflow:

```
┌─────────────────────────────────────────────────────────────┐
│                      TDD CYCLE                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. RED: Write failing test                          │   │
│  │    - Test for one acceptance criterion              │   │
│  │    - Run: npm test (MUST FAIL)                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 2. GREEN: Write minimum code                        │   │
│  │    - Just enough to pass test                       │   │
│  │    - Run: npm test (MUST PASS)                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 3. REFACTOR: Clean up                               │   │
│  │    - Improve code while tests pass                  │   │
│  │    - Run: npm test (STILL PASS)                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 4. COMMIT: Save progress                            │   │
│  │    - Commit with conventional message               │   │
│  │    - Update story file                              │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│              [Repeat for next AC]                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Step 4: Incremental Development Principles

**Minimize Changes**:
```typescript
// BAD: Rewriting entire function
function processUser(user: User) {
  // 100 lines of new code replacing old
}

// GOOD: Extend existing function
function processUser(user: User) {
  const result = existingLogic(user);  // Keep existing
  const enhanced = addNewFeature(result);  // Add new
  return enhanced;
}
```

**Maintain Backwards Compatibility**:
```typescript
// BAD: Breaking existing API
interface UserRequest {
  preferences: Preferences;  // Required - breaks existing clients
}

// GOOD: Optional new fields
interface UserRequest {
  preferences?: Preferences;  // Optional - existing clients work
}
```

**Use Feature Flags**:
```typescript
// Enable gradual rollout
if (featureFlags.newUserPreferences) {
  return <NewPreferencesPanel />;
}
return <LegacySettings />;
```

### Step 5: Quality Checks

Before marking story complete:

```bash
# Type checking
npm run type-check

# Linting
npm run lint

# Unit tests
npm test

# Integration tests (if applicable)
npm run test:integration

# Check coverage
npm run test:coverage
```

### Step 6: Story Completion

When all acceptance criteria met:

1. **Update Story File**
   - Mark all ACs verified
   - Add completion timestamp
   - Document any deviations

2. **Final Commit**
   ```bash
   git add .
   git commit -m "feat(iter-[id]): complete STORY-XXX - [title]

   - [What was implemented]
   - [Tests added]

   Implements: STORY-XXX
   Iteration: [iter-id]"
   ```

3. **Update Iteration State**

## Output Requirements

### Artifact Locations

```
docs/bmad-iter/[iter-id]/04-dev/
├── _progress.md            # Overall development progress
└── stories/
    ├── story-001.md        # Story implementation record
    ├── story-002.md
    └── story-003.md

src/                        # Code changes
tests/                      # Test changes
```

### Progress Tracking

Update `docs/bmad-iter/[iter-id]/04-dev/_progress.md`:

```markdown
# Development Progress

## Iteration: [iter-id]

### Story Status

| Story | Title | Status | Started | Completed |
|-------|-------|--------|---------|-----------|
| STORY-001 | [Title] | completed | [date] | [date] |
| STORY-002 | [Title] | in_progress | [date] | - |
| STORY-003 | [Title] | pending | - | - |

### Metrics

- Stories Completed: 1/3
- Files Changed: 8
- Tests Added: 12
- Coverage Delta: +3.2%

### Blockers

- [ ] [Blocker description] - [status]

---

Updated: [timestamp]
```

### State Update

```yaml
# .bmad-iter/state.yaml
workflow:
  current_phase: 4
  phase_status:
    3: completed
    4: in_progress
  current_story: story-002

changes:
  stories:
    - id: story-001
      status: completed
    - id: story-002
      status: in_progress
    - id: story-003
      status: pending

metrics:
  files_changed: 8
  tests_added: 12
```

## Commit Message Format

```
feat(iter-[id]): [action] [component] - STORY-XXX

- [What was implemented]
- [What was tested]

Implements: STORY-XXX
Iteration: [iter-id]
Change: CHG-XXX
```

Examples:
```
feat(iter-2025-01): add user preferences API - STORY-001

- Add POST /api/preferences endpoint
- Add preferences service
- Add unit tests for preferences

Implements: STORY-001
Iteration: iter-2025-01
Change: CHG-001
```

## Success Criteria

- [ ] Story file created with implementation log
- [ ] Tests written BEFORE implementation
- [ ] All acceptance criteria met
- [ ] All tests passing
- [ ] Code follows existing patterns
- [ ] Backwards compatible
- [ ] No unnecessary changes
- [ ] Story file updated with completion
- [ ] Commits follow convention

## Development Best Practices

### Minimize Blast Radius
- Change as few files as possible
- Preserve existing interfaces
- Use adapters for new code

### Incremental Commits
- Commit after each passing test
- Keep commits small and focused
- Easy to revert if needed

### Document Decisions
- Log why you made choices
- Note any technical debt
- Flag follow-up items

## Next Story

After completing this story:

```bash
# Check for more stories
/bmad-iter status

# Work on next story
/bmad-iter story [iter-id]/[next-story]

# Or auto-select next
/bmad-iter next
```

When all stories complete, proceed to:
```
/bmad-iter-test
```

---

**IMPORTANT**:
- Never skip tests
- Never break existing functionality
- Commit frequently
- Update story file as you work
- Flag blockers immediately
